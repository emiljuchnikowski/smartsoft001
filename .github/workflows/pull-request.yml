name: Pull Request
on:
  pull_request:
    branches:
      - main

jobs:
  main:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4.2.2
        with:
          fetch-depth: 0
      - name: Load & cache dependencies
        id: cache-deps
        uses: ./.github/actions/cached-deps
        with:
          node-version: '22'
      - run: npx nx format:check
      - run: npx nx run-many -t lint --max-parallel=4
      - run: npx nx run-many -t test --max-parallel=4
      - run: npx nx run-many -t build --max-parallel=4
      - name: Claude Code Review
        if: github.event_name == 'pull_request'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.number }}
        run: |
          # Install Claude Code CLI
          npm install -g @anthropic/claude-code

          # Get PR diff and changed files
          git fetch origin main
          CHANGED_FILES=$(git diff --name-only origin/main...HEAD)

          # Run Claude Code review on changed files
          echo "Reviewing changed files: $CHANGED_FILES"
          REVIEW_OUTPUT=$(echo "$CHANGED_FILES" | xargs claude-code review --prompt="$(cat tools/specs/CODE_REVIEW.md)" 2>&1 || echo "Review failed")

          # Escape JSON for GitHub API
          ESCAPED_REVIEW=$(echo "$REVIEW_OUTPUT" | jq -Rs .)

          # Post comment to PR
          curl -s -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/issues/$PR_NUMBER/comments" \
            -d "{\"body\": \"## ðŸ¤– Claude Code Review\\n\\n$ESCAPED_REVIEW\"}"

          echo "Code review completed and posted to PR #$PR_NUMBER"
